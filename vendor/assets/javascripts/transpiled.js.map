{"version":3,"sources":["app.js"],"names":["SNCrypto","CryptoJS","lib","WordArray","random","toString","crypto","window","msCrypto","buf","Uint32Array","getRandomValues","idx","replace","c","r","v","d","Date","getTime","performance","now","uuid","Math","floor","encrypted_content","key","keyData","enc","Hex","parse","ivData","decrypted","AES","decrypt","iv","mode","CBC","padding","pad","Pkcs7","Utf8","text","encrypted","encrypt","salt","Neeto","generateRandomKey","passphrase","PBKDF2","keySize","substring","length","Base64","base64String","SHA256","SHA1","message","messageData","HmacSHA256","email","password","pw_salt","pw_func","pw_alg","pw_cost","pw_key_size","callback","generateSymmetricKeyPair","keys","pw","mk","defaults","defaultPasswordGenerationParams","pw_nonce","sha1","_","merge","SNCryptoJS","algMapping","algo","SHA512","fnMapping","alg","kdf","output","hasher","iterations","outputLength","firstHalf","slice","secondHalf","subtleCrypto","subtle","SNCryptoWeb","stretchPassword","webCryptoImportKey","console","log","webCryptoDeriveBits","bind","input","importKey","stringToArrayBuffer","name","toUpperCase","then","catch","err","error","deriveBits","hash","bits","arrayBufferToHexString","Uint8Array","string","encoder","TextEncoder","encode","arrayBuffer","byteArray","hexString","nextHexByte","i","byteLength","angular","module","config","RestangularProvider","apiControllerProvider","setDefaultHeaders","url","defaultServerURL","setBaseUrl","setFullRequestInterceptor","element","operation","route","headers","params","httpConfig","token","localStorage","getItem","extend","Authorization","$qProvider","$stateProvider","$urlRouterProvider","$locationProvider","state","abstract","parent","views","templateUrl","controller","otherwise","$injector","$location","get","go","path","html5Mode","BaseCtrl","$rootScope","modelManager","directive","$timeout","restrict","scope","save","remove","note","user","controllerAs","bindToController","link","elem","attrs","ctrl","handler","event","ctrlKey","metaKey","String","fromCharCode","which","toLowerCase","preventDefault","saveNote","clickedEditNote","toggleMarkdown","toggleFullScreen","addEventListener","$on","removeEventListener","$watch","oldNote","setNote","$sce","apiController","markdownRenderer","editorMode","safeText","dummy","focusTitle","hasChanges","onPreviewDoubleClick","focusEditor","delay","setTimeout","document","getElementById","focus","clickedTextArea","showMenu","renderedContent","renderHtml","renderedContentForText","statusTimeout","$event","success","clearDraft","cancel","noteStatus","saveTitle","target","blur","saveTimeout","changesMade","saveDraftToDisk","contentChanged","nameChanged","onNameFocus","editingName","onContentFocus","showSampler","$broadcast","editingUrl","onNameBlur","fullscreen","selectedMenuItem","editUrlPressed","publicUrlForNote","presentation_name","base","saveUrl","original","dirty","sync","response","alert","shareNote","openInNewTab","a","createElement","href","click","shareItem","unshareNote","unshareItem","presentationURL","clickedMenu","locked","deleteNote","extensionManager","logout","syncUpdated","$state","serverSideValidation","changePasswordPressed","showNewPasswordForm","accountMenuPressed","serverData","getServer","showAccountMenu","showFaq","toggleExtensions","showExtensionsMenu","toggleExtensionForm","newExtensionData","showNewExtensionForm","submitNewExtensionForm","addExtension","selectedAction","action","extension","executeAction","reloadExtensionsPressed","confirm","refreshExtensionsFromServer","changeServer","setServer","signOutPressed","signout","location","reload","submitPasswordChange","passwordChangeData","status","data","password_confirmation","changePassword","current_password","new_password","hasLocalData","filteredNotes","mergeLocalChanged","shouldMerge","refreshData","isRefreshing","lastSyncDate","loginSubmitPressed","loginData","login","user_password","onAuthSuccess","submitRegistrationForm","register","forgotPasswordSubmit","encryptionStatusForNotes","allNotes","countEncrypted","forEach","encryptionEnabled","downloadDataArchive","setAttribute","itemsDataFile","importFileSelected","files","file","reader","FileReader","onload","e","importJSONData","result","readAsText","showLogin","showRegistration","$scope","bodyClass","onUserSet","setUser","defaultUser","allTag","Tag","all","title","tags","notes","setInterval","getCurrentUser","User","loadLocalItemsAndUser","updateAllTag","tagsWillMakeSelection","tag","tagsSelectionMade","selectedTag","selectedNote","removeItemLocally","tagsAddNew","addItem","tagsSave","tagsUpdateNoteTag","noteCopy","newTag","oldTag","originalNote","find","createRelationshipBetweenItems","notesRemoveTag","validNotes","Note","filterDummyNotes","setItemToBeDeleted","notesSelectionMade","notesAddNew","headerLogout","addNew","selectionMade","removeTag","tagDidChange","isFirstLoad","noteFilter","visible","selectFirstNote","draft","getDraft","selectNote","createNewNote","selectedTagDelete","selectedTagShare","selectedTagUnshare","createNew","visibleNotes","filter","newNote","filterNotes","includes","filterTextChanged","willSelect","updateNoteTag","newTags","setTags","setAllTag","initialLoad","selectTag","clickedAddNewTag","editingTag","originalTagName","onTagTitleFocus","tagTitleDidChange","saveTag","savedTag","noteCount","handleDrop","Restangular","formData","saveUsername","setUsername","username","closeThisDialog","Item","json_obj","updateFromJSON","generateUUID","json","created_at","updated_at","content","mapContentToLocalProperties","contentObject","contentObj","structureParams","references","referenceParams","item","omit","enc_item_key","presentation_url","JSON","items","sort","b","Action","comps","type","split","repeatable","repeatType","repeatVerb","repeatFrequency","Extension","content_type","actions","map","externalResponseItem","push","pull","hasOnePublicTag","isPublic","filtered","unshift","provider","domainName","domain_comps","hostname","domain","$get","ngDialog","ApiController","refresh","setItem","getAuthParamsForEmail","request","one","plain","authParams","computeEncryptionKeysForUser","setMk","post","generateInitialEncryptionKeysForUser","currentKeys","newKeys","_performPasswordChange","reencryptAllItemsAndSave","current_keys","new_keys","patch","verifyEncryptionStatusOfAllItems","allItems","filteredItems","itemsNeedingUpdate","isEncrypted","saveBatchItems","syncWithOptions","options","writeItemsToLocalStorage","responseItems","handleItemsResponse","clearDirtyItems","dirtyItems","getDirtyItems","createRequestParamsForItem","additionalFields","syncToken","sync_token","retrieved_items","omitFields","saved_items","undefined","decryptItems","mapResponseItemsToLocalModelsOmittingFields","paramsForItem","forExportFile","itemCopy","cloneDeep","assert","deleted","encryptSingleItem","retrieveMk","auth_hash","base64","stringify","createContentJSONFromProperties","pick","shareFn","needsUpdate","concat","referencesAffectedBySharingChange","needingUpdate","open","template","resolve","className","disableAnimation","jsonString","mapResponseItemsToLocalModels","textFile","makeTextFile","Blob","URL","revokeObjectURL","createObjectURL","mergeLocalDataRemotely","tag_id","tag_name","removeItem","staticifyObject","object","writeToLocalStorage","value","toJson","sortItemsByDate","draftString","masterKey","item_key","decryptText","generateRandomEncryptionKey","encryptText","ek","firstHalfOfKey","ak","secondHalfOfKey","encryptedContent","authHash","hmac256","local_encryption_scheme","decryptSingleItem","base64Decode","newMasterKey","oldMasterKey","shouldFocus","$element","el","draggable","dataTransfer","effectAllowed","setData","classList","add","drop","bin","dropEffect","counter","stopPropagation","binId","getData","$apply","fn","on","require","modelCtrl","lowercase","inputValue","lowercased","$setViewValue","$render","$parsers","ngModel","$window","getSelection","setSelectionRange","linkFunction","$attrs","timer","initialDelay","getTypeDelay","typeDelay","eraseDelay","blinkDelay","getAnimationDelay","cursor","blinkCursor","currentText","textArray","running","auxStyle","Array","start","typewrite","updateIt","charIndex","arrIndex","updateValue","iterationCallback","cleanAndRestart","iterationDelay","callbackFn","blinkIt","prebeginFn","charAt","parseInt","prop","val","html","newVal","oldVal","ExtensionManager","enabledRepeatActionUrls","addItemSyncObserver","ext","enableRepeatAction","extensions","retrieveExtensionFromServer","oneUrl","handleExtensionLoadExternalResponseItem","updateFromExternalResponseItem","actionWithURL","disableRepeatAction","removeItemSyncObserver","isRepeatActionEnabled","structures","structure","changedItems","triggerWatchAction","actionQueue","lastExecuted","diffInSeconds","queueAction","service","$filter","marked","setOptions","breaks","sanitize","html_code","trustAsHtml","ModelManager","itemSyncObservers","itemId","models","findItem","createItem","resolveReferencesForItem","observer","relevantItems","sortItems","uniq","addItems","contentType","reference","referencedItem","addItemAsRelationship","id","removeAllRelationships","itemOne","itemTwo","removeItemAsRelationship","showErrors","formErrors","form","errors","$setDirty","$setValidity","$error","server","join","parseErrors"],"mappings":"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","file":"transpiled.js","sourcesContent":["class SNCrypto {\n\n  generateRandomKey() {\n    return CryptoJS.lib.WordArray.random(512/8).toString();\n  }\n\n  generateUUID() {\n    var crypto = window.crypto || window.msCrypto;\n    if(crypto) {\n      var buf = new Uint32Array(4);\n      crypto.getRandomValues(buf);\n      var idx = -1;\n      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n          idx++;\n          var r = (buf[idx>>3] >> ((idx%8)*4))&15;\n          var v = c == 'x' ? r : (r&0x3|0x8);\n          return v.toString(16);\n      });\n    } else {\n      var d = new Date().getTime();\n      if(window.performance && typeof window.performance.now === \"function\"){\n        d += performance.now(); //use high-precision timer if available\n      }\n      var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = (d + Math.random()*16)%16 | 0;\n        d = Math.floor(d/16);\n        return (c=='x' ? r : (r&0x3|0x8)).toString(16);\n      });\n      return uuid;\n    }\n  }\n\n  decryptText(encrypted_content, key) {\n    var keyData = CryptoJS.enc.Hex.parse(key);\n    var ivData  = CryptoJS.enc.Hex.parse(\"\");\n    var decrypted = CryptoJS.AES.decrypt(encrypted_content, keyData, { iv: ivData,  mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });\n    return decrypted.toString(CryptoJS.enc.Utf8);\n  }\n\n  encryptText(text, key) {\n    var keyData = CryptoJS.enc.Hex.parse(key);\n    var ivData  = CryptoJS.enc.Hex.parse(\"\");\n    var encrypted = CryptoJS.AES.encrypt(text, keyData, { iv: ivData,  mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });\n    return encrypted.toString();\n  }\n\n  generateRandomEncryptionKey() {\n    var salt = Neeto.crypto.generateRandomKey();\n    var passphrase = Neeto.crypto.generateRandomKey();\n    return CryptoJS.PBKDF2(passphrase, salt, { keySize: 512/32 }).toString();\n  }\n\n  firstHalfOfKey(key) {\n    return key.substring(0, key.length/2);\n  }\n\n  secondHalfOfKey(key) {\n    return key.substring(key.length/2, key.length);\n  }\n\n  base64(text) {\n    return CryptoJS.enc.Utf8.parse(text).toString(CryptoJS.enc.Base64)\n  }\n\n  base64Decode(base64String) {\n    return CryptoJS.enc.Base64.parse(base64String).toString(CryptoJS.enc.Utf8)\n  }\n\n  sha256(text) {\n    return CryptoJS.SHA256(text).toString();\n  }\n\n  sha1(text) {\n    return CryptoJS.SHA1(text).toString();\n  }\n\n  hmac256(message, key) {\n    var keyData = CryptoJS.enc.Hex.parse(key);\n    var messageData = CryptoJS.enc.Utf8.parse(message);\n    return CryptoJS.HmacSHA256(messageData, keyData).toString();\n  }\n\n  computeEncryptionKeysForUser({email, password, pw_salt, pw_func, pw_alg, pw_cost, pw_key_size} = {}, callback) {\n     this.generateSymmetricKeyPair({password: password, pw_salt: pw_salt,\n       pw_func: pw_func, pw_alg: pw_alg, pw_cost: pw_cost, pw_key_size: pw_key_size}, function(keys){\n         var pw = keys[0];\n         var mk = keys[1];\n\n         callback({pw: pw, mk: mk});\n       });\n   }\n\n   generateInitialEncryptionKeysForUser({email, password} = {}, callback) {\n     var defaults = this.defaultPasswordGenerationParams();\n     var {pw_func, pw_alg, pw_key_size, pw_cost} = defaults;\n     var pw_nonce = this.generateRandomKey();\n     var pw_salt = this.sha1(email + \"SN\" + pw_nonce);\n     this.generateSymmetricKeyPair(_.merge({email: email, password: password, pw_salt: pw_salt}, defaults), function(keys){\n       var pw = keys[0];\n       var mk = keys[1];\n\n       callback(_.merge({pw: pw, mk: mk, pw_nonce: pw_nonce}, defaults));\n     });\n   }\n}\n\nexport { SNCrypto }\n;class SNCryptoJS extends SNCrypto {\n\n   /** Generates two deterministic keys based on one input */\n   generateSymmetricKeyPair({password, pw_salt, pw_func, pw_alg, pw_cost, pw_key_size} = {}, callback) {\n     var algMapping = {\n       \"sha256\" : CryptoJS.algo.SHA256,\n       \"sha512\" : CryptoJS.algo.SHA512\n     }\n     var fnMapping = {\n       \"pbkdf2\" : CryptoJS.PBKDF2\n     }\n\n     var alg = algMapping[pw_alg];\n     var kdf = fnMapping[pw_func];\n     var output = kdf(password, pw_salt, { keySize: pw_key_size/32, hasher: alg, iterations: pw_cost }).toString();\n\n     var outputLength = output.length;\n     var firstHalf = output.slice(0, outputLength/2);\n     var secondHalf = output.slice(outputLength/2, outputLength);\n     callback([firstHalf, secondHalf])\n   }\n\n   defaultPasswordGenerationParams() {\n     return {pw_func: \"pbkdf2\", pw_alg: \"sha512\", pw_key_size: 512, pw_cost: 3000};\n   }\n }\n\n\nexport { SNCryptoJS }\n;var subtleCrypto = window.crypto.subtle;\n\nclass SNCryptoWeb extends SNCrypto {\n\n  /**\n  Overrides\n  */\n  defaultPasswordGenerationParams() {\n    return {pw_func: \"pbkdf2\", pw_alg: \"sha512\", pw_key_size: 512, pw_cost: 5000};\n  }\n\n  /** Generates two deterministic keys based on one input */\n  generateSymmetricKeyPair({password, pw_salt, pw_func, pw_alg, pw_cost, pw_key_size} = {}, callback) {\n   this.stretchPassword({password: password, pw_func: pw_func, pw_alg: pw_alg, pw_salt: pw_salt, pw_cost: pw_cost, pw_key_size: pw_key_size}, function(output){\n     var outputLength = output.length;\n     var firstHalf = output.slice(0, outputLength/2);\n     var secondHalf = output.slice(outputLength/2, outputLength);\n     callback([firstHalf, secondHalf]);\n   })\n  }\n\n  /**\n  Internal\n  */\n\n  stretchPassword({password, pw_salt, pw_cost, pw_func, pw_alg, pw_key_size} = {}, callback) {\n\n   this.webCryptoImportKey(password, pw_func, function(key){\n\n     if(!key) {\n       console.log(\"Key is null, unable to continue\");\n       callback(null);\n       return;\n     }\n\n     this.webCryptoDeriveBits({key: key, pw_func: pw_func, pw_alg: pw_alg, pw_salt: pw_salt, pw_cost: pw_cost, pw_key_size: pw_key_size}, function(key){\n       if(!key) {\n         callback(null);\n         return;\n       }\n\n       callback(key);\n\n     }.bind(this))\n   }.bind(this))\n  }\n\n  webCryptoImportKey(input, pw_func, callback) {\n     subtleCrypto.importKey(\n      \"raw\",\n      this.stringToArrayBuffer(input),\n      {name: pw_func.toUpperCase()},\n      false,\n      [\"deriveBits\"]\n    )\n    .then(function(key){\n      callback(key);\n    })\n    .catch(function(err){\n      console.error(err);\n      callback(null);\n    });\n  }\n\n  webCryptoDeriveBits({key, pw_func, pw_alg, pw_salt, pw_cost, pw_key_size} = {}, callback) {\n     var algMapping = {\n       \"sha256\" : \"SHA-256\",\n       \"sha512\" : \"SHA-512\",\n     }\n     var alg = algMapping[pw_alg];\n     subtleCrypto.deriveBits(\n      {\n        \"name\": pw_func.toUpperCase(),\n        salt: this.stringToArrayBuffer(pw_salt),\n        iterations: pw_cost,\n        hash: {name: alg},\n      },\n      key,\n      pw_key_size\n    )\n    .then(function(bits){\n      var key = this.arrayBufferToHexString(new Uint8Array(bits));\n      callback(key);\n    }.bind(this))\n    .catch(function(err){\n      console.error(err);\n      callback(null);\n    });\n  }\n\n  stringToArrayBuffer(string) {\n     var encoder = new TextEncoder(\"utf-8\");\n     return encoder.encode(string);\n   }\n\n  arrayBufferToHexString(arrayBuffer) {\n      var byteArray = new Uint8Array(arrayBuffer);\n      var hexString = \"\";\n      var nextHexByte;\n\n      for (var i=0; i<byteArray.byteLength; i++) {\n          nextHexByte = byteArray[i].toString(16);\n          if (nextHexByte.length < 2) {\n              nextHexByte = \"0\" + nextHexByte;\n          }\n          hexString += nextHexByte;\n      }\n      return hexString;\n  }\n}\n\nexport { SNCryptoWeb }\n;'use strict';\n\nvar Neeto = Neeto || {};\n\nif(window.crypto.subtle) {\n  Neeto.crypto = new SNCryptoWeb();\n} else {\n  Neeto.crypto = new SNCryptoJS();\n}\n\nangular.module('app.frontend', [\n  'ui.router',\n  'restangular',\n  'oc.lazyLoad',\n  'angularLazyImg',\n  'ngDialog'\n])\n\n.config(function (RestangularProvider, apiControllerProvider) {\n  RestangularProvider.setDefaultHeaders({\"Content-Type\": \"application/json\"});\n\n  var url = apiControllerProvider.defaultServerURL();\n  RestangularProvider.setBaseUrl(url + \"/api\");\n\n  RestangularProvider.setFullRequestInterceptor(function(element, operation, route, url, headers, params, httpConfig) {\n    var token = localStorage.getItem(\"jwt\");\n    if(token) {\n      headers = _.extend(headers, {Authorization: \"Bearer \" + localStorage.getItem(\"jwt\")});\n    }\n\n    return {\n      element: element,\n      params: params,\n      headers: headers,\n      httpConfig: httpConfig\n    };\n  });\n})\n.config(['$qProvider', function ($qProvider) {\n    // $qProvider.errorOnUnhandledRejections(false);\n}]);\n;angular.module('app.frontend')\n  .config(function ($stateProvider, $urlRouterProvider, $locationProvider) {\n\n    $stateProvider\n      .state('base', {\n        abstract: true,\n      })\n\n      .state('home', {\n        url: '/',\n        parent: 'base',\n        views: {\n          'content@' : {\n            templateUrl: 'frontend/home.html',\n            controller: 'HomeCtrl'\n          }\n        }\n      })\n\n      // 404 Error\n      .state('404', {\n        parent: 'base',\n        views: {\n          'content@' : {\n            templateUrl: 'frontend/errors/404.html'\n          }\n        }\n      });\n\n      // Default fall back route\n      $urlRouterProvider.otherwise(function($injector, $location){\n         var state = $injector.get('$state');\n         state.go('404');\n         return $location.path();\n      });\n\n      // enable HTML5 Mode for SEO\n      $locationProvider.html5Mode(true);\n\n  });\n;class BaseCtrl {\n  constructor($rootScope, modelManager) {\n    // $rootScope.resetPasswordSubmit = function() {\n    //   var new_keys = Neeto.crypto.generateEncryptionKeysForUser($rootScope.resetData.password, $rootScope.resetData.email);\n    //   var data = _.clone($rootScope.resetData);\n    //   data.password = new_keys.pw;\n    //   data.password_confirmation = new_keys.pw;\n    //   $auth.updatePassword(data);\n    //   apiController.setMk(new_keys.mk);\n    // }\n  }\n}\n\nangular.module('app.frontend').controller('BaseCtrl', BaseCtrl);\n;angular.module('app.frontend')\n  .directive(\"editorSection\", function($timeout){\n    return {\n      restrict: 'E',\n      scope: {\n        save: \"&\",\n        remove: \"&\",\n        note: \"=\",\n        user: \"=\"\n      },\n      templateUrl: 'frontend/editor.html',\n      replace: true,\n      controller: 'EditorCtrl',\n      controllerAs: 'ctrl',\n      bindToController: true,\n\n      link:function(scope, elem, attrs, ctrl) {\n\n        var handler = function(event) {\n          if (event.ctrlKey || event.metaKey) {\n              switch (String.fromCharCode(event.which).toLowerCase()) {\n              case 's':\n                  event.preventDefault();\n                  $timeout(function(){\n                    ctrl.saveNote(event);\n                  });\n                  break;\n              case 'e':\n                  event.preventDefault();\n                  $timeout(function(){\n                    ctrl.clickedEditNote();\n                  })\n                  break;\n              case 'm':\n                  event.preventDefault();\n                  $timeout(function(){\n                    ctrl.toggleMarkdown();\n                  })\n                  break;\n              case 'o':\n                  event.preventDefault();\n                  $timeout(function(){\n                    ctrl.toggleFullScreen();\n                  })\n                  break;\n              }\n          }\n        };\n\n        window.addEventListener('keydown', handler);\n\n        scope.$on('$destroy', function(){\n          window.removeEventListener('keydown', handler);\n        })\n\n        scope.$watch('ctrl.note', function(note, oldNote){\n          if(note) {\n            ctrl.setNote(note, oldNote);\n          } else {\n            ctrl.note = {};\n          }\n        });\n      }\n    }\n  })\n  .controller('EditorCtrl', function ($sce, $timeout, apiController, markdownRenderer, $rootScope) {\n\n    this.setNote = function(note, oldNote) {\n      this.editorMode = 'edit';\n\n      if(note.safeText().length == 0 && note.dummy) {\n        this.focusTitle(100);\n      }\n\n      if(oldNote && oldNote != note) {\n        if(oldNote.hasChanges) {\n          this.save()(oldNote, null);\n        } else if(oldNote.dummy) {\n          this.remove()(oldNote);\n        }\n      }\n    }\n\n    this.onPreviewDoubleClick = function() {\n      this.editorMode = 'edit';\n      this.focusEditor(100);\n    }\n\n    this.focusEditor = function(delay) {\n      setTimeout(function(){\n        var element = document.getElementById(\"note-text-editor\");\n        element.focus();\n      }, delay)\n    }\n\n    this.focusTitle = function(delay) {\n      setTimeout(function(){\n        document.getElementById(\"note-title-editor\").focus();\n      }, delay)\n    }\n\n    this.clickedTextArea = function() {\n      this.showMenu = false;\n    }\n\n    this.renderedContent = function() {\n      return markdownRenderer.renderHtml(markdownRenderer.renderedContentForText(this.note.safeText()));\n    }\n\n    var statusTimeout;\n\n    this.saveNote = function($event) {\n      var note = this.note;\n      note.dummy = false;\n      this.save()(note, function(success){\n        if(success) {\n          apiController.clearDraft();\n\n          if(statusTimeout) $timeout.cancel(statusTimeout);\n          statusTimeout = $timeout(function(){\n            this.noteStatus = \"All changes saved\"\n          }.bind(this), 200)\n        }\n      }.bind(this));\n    }\n\n    this.saveTitle = function($event) {\n      $event.target.blur();\n      this.saveNote($event);\n      this.focusEditor();\n    }\n\n    var saveTimeout;\n    this.changesMade = function() {\n      this.note.hasChanges = true;\n      this.note.dummy = false;\n      if(this.user.uuid) {\n        // signed out users have local autosave, dont need draft saving\n        apiController.saveDraftToDisk(this.note);\n      }\n\n      if(saveTimeout) $timeout.cancel(saveTimeout);\n      if(statusTimeout) $timeout.cancel(statusTimeout);\n      saveTimeout = $timeout(function(){\n        this.noteStatus = \"Saving...\";\n        this.saveNote();\n      }.bind(this), 150)\n    }\n\n\n    this.contentChanged = function() {\n      this.changesMade();\n    }\n\n    this.nameChanged = function() {\n      this.changesMade();\n    }\n\n    this.onNameFocus = function() {\n      this.editingName = true;\n    }\n\n    this.onContentFocus = function() {\n      this.showSampler = false;\n      $rootScope.$broadcast(\"editorFocused\");\n      this.editingUrl = false;\n    }\n\n    this.onNameBlur = function() {\n      this.editingName = false;\n    }\n\n    this.toggleFullScreen = function() {\n      this.fullscreen = !this.fullscreen;\n      if(this.fullscreen) {\n        if(this.editorMode == 'edit') {\n          // refocus\n          this.focusEditor(0);\n        }\n      } else {\n\n      }\n    }\n\n    this.selectedMenuItem = function() {\n      this.showMenu = false;\n    }\n\n    this.toggleMarkdown = function() {\n      if(this.editorMode == 'preview') {\n        this.editorMode = 'edit';\n      } else {\n        this.editorMode = 'preview';\n      }\n    }\n\n    this.editUrlPressed = function() {\n      this.showMenu = false;\n      var url = this.publicUrlForNote(this.note);\n      url = url.replace(this.note.presentation_name, \"\");\n      this.url = {base: url, token : this.note.presentation_name};\n      this.editingUrl = true;\n    }\n\n    this.saveUrl = function($event) {\n      $event.target.blur();\n\n      var original = this.note.presentation_name;\n      this.note.presentation_name = this.url.token;\n      this.note.dirty = true;\n\n      apiController.sync(function(response){\n        if(!response) {\n          this.note.presentation_name = original;\n          this.url.token = original;\n          alert(\"This URL is not available.\");\n        } else {\n          this.editingUrl = false;\n        }\n      }.bind(this))\n    }\n\n    this.shareNote = function() {\n\n      function openInNewTab(url) {\n        var a = document.createElement(\"a\");\n        a.target = \"_blank\";\n        a.href = url;\n        a.click();\n    }\n\n      apiController.shareItem(this.note, function(note){\n        openInNewTab(this.publicUrlForNote(note));\n      }.bind(this))\n      this.showMenu = false;\n    }\n\n    this.unshareNote = function() {\n      apiController.unshareItem(this.note, function(note){\n\n      })\n      this.showMenu = false;\n    }\n\n    this.publicUrlForNote = function() {\n      return this.note.presentationURL();\n    }\n\n    this.clickedMenu = function() {\n      if(this.note.locked) {\n        alert(\"This note has been shared without an account, and can therefore not be changed.\")\n      } else {\n        this.showMenu = !this.showMenu;\n      }\n    }\n\n    this.deleteNote = function() {\n      apiController.clearDraft();\n      this.remove()(this.note);\n      this.showMenu = false;\n    }\n\n    this.clickedEditNote = function() {\n      this.editorMode = 'edit';\n      this.focusEditor(100);\n    }\n\n  });\n;angular.module('app.frontend')\n  .directive(\"header\", function(apiController, extensionManager){\n    return {\n      restrict: 'E',\n      scope: {\n        user: \"=\",\n        logout: \"&\"\n      },\n      templateUrl: 'frontend/header.html',\n      replace: true,\n      controller: 'HeaderCtrl',\n      controllerAs: 'ctrl',\n      bindToController: true,\n\n      link:function(scope, elem, attrs, ctrl) {\n        scope.$on(\"sync:updated_token\", function(){\n          ctrl.syncUpdated();\n        })\n      }\n    }\n  })\n  .controller('HeaderCtrl', function ($state, apiController, modelManager, serverSideValidation, $timeout, extensionManager) {\n\n    this.extensionManager = extensionManager;\n\n    this.changePasswordPressed = function() {\n      this.showNewPasswordForm = !this.showNewPasswordForm;\n    }\n\n    this.accountMenuPressed = function() {\n      this.serverData = {url: apiController.getServer()};\n      this.showAccountMenu = !this.showAccountMenu;\n      this.showFaq = false;\n      this.showNewPasswordForm = false;\n    }\n\n    this.toggleExtensions = function() {\n      this.showExtensionsMenu = !this.showExtensionsMenu;\n    }\n\n    this.toggleExtensionForm = function() {\n      this.newExtensionData = {};\n      this.showNewExtensionForm = !this.showNewExtensionForm;\n    }\n\n    this.submitNewExtensionForm = function() {\n      extensionManager.addExtension(this.newExtensionData.url)\n    }\n\n    this.selectedAction = function(action, extension) {\n      extensionManager.executeAction(action, extension, function(response){\n        apiController.sync(null);\n      })\n    }\n\n    this.reloadExtensionsPressed = function() {\n      if(confirm(\"For your security, reloading extensions will disable any currently enabled repeat actions.\")) {\n        extensionManager.refreshExtensionsFromServer();\n      }\n    }\n\n    this.changeServer = function() {\n      apiController.setServer(this.serverData.url, true);\n    }\n\n    this.signOutPressed = function() {\n      this.showAccountMenu = false;\n      this.logout()();\n      apiController.signout();\n      window.location.reload();\n    }\n\n    this.submitPasswordChange = function() {\n      this.passwordChangeData.status = \"Generating New Keys...\";\n\n      $timeout(function(){\n        if(data.password != data.password_confirmation) {\n          alert(\"Your new password does not match its confirmation.\");\n          return;\n        }\n\n        apiController.changePassword(this.user, this.passwordChangeData.current_password, this.passwordChangeData.new_password, function(response){\n\n        })\n\n      }.bind(this))\n    }\n\n    this.hasLocalData = function() {\n      return modelManager.filteredNotes.length > 0;\n    }\n\n    this.mergeLocalChanged = function() {\n      if(!this.user.shouldMerge) {\n        if(!confirm(\"Unchecking this option means any locally stored tags and notes you have now will be deleted. Are you sure you want to continue?\")) {\n          this.user.shouldMerge = true;\n        }\n      }\n    }\n\n    this.refreshData = function() {\n      this.isRefreshing = true;\n      apiController.sync(function(response){\n        $timeout(function(){\n          this.isRefreshing = false;\n        }.bind(this), 200)\n        if(!response) {\n          alert(\"There was an error syncing. Please try again. If all else fails, log out and log back in.\");\n        } else {\n          this.syncUpdated();\n        }\n      }.bind(this));\n    }\n\n    this.syncUpdated = function() {\n      this.lastSyncDate = new Date();\n    }\n\n    this.loginSubmitPressed = function() {\n      this.loginData.status = \"Generating Login Keys...\";\n      $timeout(function(){\n        apiController.login(this.loginData.email, this.loginData.user_password, function(response){\n          if(!response || response.error) {\n            var error = response ? response.error : {message: \"An unknown error occured.\"}\n            this.loginData.status = null;\n            alert(error.message);\n          } else {\n            this.onAuthSuccess(response.user);\n          }\n        }.bind(this));\n      }.bind(this))\n    }\n\n    this.submitRegistrationForm = function() {\n      this.loginData.status = \"Generating Account Keys...\";\n\n      $timeout(function(){\n        apiController.register(this.loginData.email, this.loginData.user_password, function(response){\n          if(!response || response.error) {\n            var error = response ? response.error : {message: \"An unknown error occured.\"}\n            this.loginData.status = null;\n            alert(error.message);\n          } else {\n            this.onAuthSuccess(response.user);\n          }\n        }.bind(this));\n      }.bind(this))\n    }\n\n    this.forgotPasswordSubmit = function() {\n      // $auth.requestPasswordReset(this.resetData)\n      //   .then(function(resp) {\n      //     this.resetData.response = \"Success\";\n      //     // handle success response\n      //   }.bind(this))\n      //   .catch(function(resp) {\n      //     // handle error response\n      //     this.resetData.response = \"Error\";\n      //   }.bind(this));\n    }\n\n    this.encryptionStatusForNotes = function() {\n      var allNotes = modelManager.filteredNotes;\n      var countEncrypted = 0;\n      allNotes.forEach(function(note){\n        if(note.encryptionEnabled()) {\n          countEncrypted++;\n        }\n      }.bind(this))\n\n      return countEncrypted + \"/\" + allNotes.length + \" notes encrypted\";\n    }\n\n    this.downloadDataArchive = function() {\n      var link = document.createElement('a');\n      link.setAttribute('download', 'notes.json');\n      link.href = apiController.itemsDataFile();\n      link.click();\n    }\n\n    this.importFileSelected = function(files) {\n      var file = files[0];\n      var reader = new FileReader();\n      reader.onload = function(e) {\n        apiController.importJSONData(e.target.result, function(success, response){\n          console.log(\"import response\", success, response);\n          if(success) {\n            // window.location.reload();\n          } else {\n            alert(\"There was an error importing your data. Please try again.\");\n          }\n        })\n      }\n      reader.readAsText(file);\n    }\n\n    this.onAuthSuccess = function(user) {\n      this.user.uuid = user.uuid;\n\n      // if(this.user.shouldMerge && this.hasLocalData()) {\n        // apiController.mergeLocalDataRemotely(this.user, function(){\n        //   window.location.reload();\n        // });\n      // } else {\n        window.location.reload();\n      // }\n\n      this.showLogin = false;\n      this.showRegistration = false;\n    }\n\n  });\n;angular.module('app.frontend')\n.controller('HomeCtrl', function ($scope, $rootScope, $timeout, apiController, modelManager) {\n    $rootScope.bodyClass = \"app-body-class\";\n\n    var onUserSet = function() {\n      apiController.setUser($scope.defaultUser);\n      $scope.allTag = new Tag({all: true});\n      $scope.allTag.title = \"All\";\n      $scope.tags = modelManager.tags;\n      $scope.allTag.notes = modelManager.notes;\n\n      apiController.sync(null);\n      // refresh every 30s\n      setInterval(function () {\n        apiController.sync(null);\n      }, 30000);\n    }\n\n    apiController.getCurrentUser(function(user){\n      if(user) {\n        $scope.defaultUser = user;\n        $rootScope.title = \"Notes — Standard Notes\";\n        onUserSet();\n      } else {\n        $scope.defaultUser = new User(apiController.loadLocalItemsAndUser());\n        onUserSet();\n      }\n    });\n\n    /*\n    Tags Ctrl Callbacks\n    */\n\n    $scope.updateAllTag = function() {\n      // $scope.allTag.notes = modelManager.notes;\n    }\n\n    $scope.tagsWillMakeSelection = function(tag) {\n      if(tag.all) {\n        $scope.updateAllTag();\n      }\n    }\n\n    $scope.tagsSelectionMade = function(tag) {\n      $scope.selectedTag = tag;\n\n      if($scope.selectedNote && $scope.selectedNote.dummy) {\n        modelManager.removeItemLocally($scope.selectedNote);\n      }\n    }\n\n    $scope.tagsAddNew = function(tag) {\n      modelManager.addItem(tag);\n    }\n\n    $scope.tagsSave = function(tag, callback) {\n      tag.dirty = true;\n      apiController.sync(callback);\n    }\n\n    /*\n    Called to update the tag of a note after drag and drop change\n    The note object is a copy of the original\n    */\n    $scope.tagsUpdateNoteTag = function(noteCopy, newTag, oldTag) {\n\n      var originalNote = _.find(modelManager.notes, {uuid: noteCopy.uuid});\n      if(!newTag.all) {\n        modelManager.createRelationshipBetweenItems(newTag, originalNote);\n      }\n\n      apiController.sync(function(){});\n    }\n\n    /*\n    Notes Ctrl Callbacks\n    */\n\n    $scope.notesRemoveTag = function(tag) {\n      var validNotes = Note.filterDummyNotes(tag.notes);\n      if(validNotes == 0) {\n        modelManager.setItemToBeDeleted(tag);\n        // if no more notes, delete tag\n        apiController.sync(function(){\n          // force scope tags to update on sub directives\n          $scope.tags = [];\n          $timeout(function(){\n            $scope.tags = modelManager.tags;\n          })\n        });\n      } else {\n        alert(\"To delete this tag, remove all its notes first.\");\n      }\n    }\n\n    $scope.notesSelectionMade = function(note) {\n      $scope.selectedNote = note;\n    }\n\n    $scope.notesAddNew = function(note) {\n      modelManager.addItem(note);\n\n      if(!$scope.selectedTag.all) {\n        modelManager.createRelationshipBetweenItems($scope.selectedTag, note);\n        $scope.updateAllTag();\n      }\n    }\n\n    /*\n    Shared Callbacks\n    */\n\n    $scope.saveNote = function(note, callback) {\n      note.dirty = true;\n\n      apiController.sync(function(){\n        note.hasChanges = false;\n\n        if(callback) {\n          callback(true);\n        }\n      })\n    }\n\n    $scope.deleteNote = function(note) {\n\n      modelManager.setItemToBeDeleted(note);\n\n      if(note == $scope.selectedNote) {\n        $scope.selectedNote = null;\n      }\n\n      if(note.dummy) {\n        modelManager.removeItemLocally(note);\n        return;\n      }\n\n      apiController.sync(null);\n    }\n\n    /*\n    Header Ctrl Callbacks\n    */\n\n    $scope.headerLogout = function() {\n      $scope.defaultUser = apiController.loadLocalItemsAndUser();\n      $scope.tags = $scope.defaultUser.tags;\n    }\n\n\n});\n;angular.module('app.frontend')\n  .directive(\"notesSection\", function(){\n    return {\n      scope: {\n        addNew: \"&\",\n        selectionMade: \"&\",\n        remove: \"&\",\n        tag: \"=\",\n        user: \"=\",\n        removeTag: \"&\"\n      },\n\n      templateUrl: 'frontend/notes.html',\n      replace: true,\n      controller: 'NotesCtrl',\n      controllerAs: 'ctrl',\n      bindToController: true,\n\n      link:function(scope, elem, attrs, ctrl) {\n        scope.$watch('ctrl.tag', function(tag, oldTag){\n          if(tag) {\n            ctrl.tagDidChange(tag, oldTag);\n          }\n        });\n      }\n    }\n  })\n  .controller('NotesCtrl', function (apiController, $timeout, $rootScope) {\n\n    $rootScope.$on(\"editorFocused\", function(){\n      this.showMenu = false;\n    }.bind(this))\n\n    var isFirstLoad = true;\n\n    this.tagDidChange = function(tag, oldTag) {\n      this.showMenu = false;\n\n      if(this.selectedNote && this.selectedNote.dummy) {\n        _.remove(oldTag.notes, this.selectedNote);\n      }\n\n      this.noteFilter.text = \"\";\n\n      tag.notes.forEach(function(note){\n        note.visible = true;\n      })\n      this.selectFirstNote(false);\n\n      if(isFirstLoad) {\n        $timeout(function(){\n          var draft = apiController.getDraft();\n          if(draft) {\n            var note = draft;\n            this.selectNote(note);\n          } else {\n            this.createNewNote();\n            isFirstLoad = false;\n          }\n        }.bind(this))\n      } else if(tag.notes.length == 0) {\n          this.createNewNote();\n      }\n    }\n\n    this.selectedTagDelete = function() {\n      this.showMenu = false;\n      this.removeTag()(this.tag);\n    }\n\n    this.selectedTagShare = function() {\n      this.showMenu = false;\n\n      if(!this.user.uuid) {\n        alert(\"You must be signed in to share a tag.\");\n        return;\n      }\n\n      if(this.tag.all) {\n        alert(\"You cannot share the 'All' tag.\");\n        return;\n      }\n\n      apiController.shareItem(this.tag, function(response){})\n    }\n\n    this.selectedTagUnshare = function() {\n      this.showMenu = false;\n      apiController.unshareItem(this.tag, function(response){\n\n      })\n    }\n\n    this.selectFirstNote = function(createNew) {\n      var visibleNotes = this.tag.notes.filter(function(note){\n        return note.visible;\n      });\n\n      if(visibleNotes.length > 0) {\n        this.selectNote(visibleNotes[0]);\n      } else if(createNew) {\n        this.createNewNote();\n      }\n    }\n\n    this.selectNote = function(note) {\n      this.selectedNote = note;\n      this.selectionMade()(note);\n    }\n\n    this.createNewNote = function() {\n      var title = \"New Note\" + (this.tag.notes ? (\" \" + (this.tag.notes.length + 1)) : \"\");\n      this.newNote = new Note({dummy: true, text: \"\"});\n      this.newNote.title = title;\n      this.selectNote(this.newNote);\n      this.addNew()(this.newNote);\n    }\n\n    this.noteFilter = {text : ''};\n\n    this.filterNotes = function(note) {\n      if(this.noteFilter.text.length == 0) {\n        note.visible = true;\n      } else {\n        note.visible = note.title.toLowerCase().includes(this.noteFilter.text) || note.text.toLowerCase().includes(this.noteFilter.text);\n      }\n      return note.visible;\n    }.bind(this)\n\n    this.filterTextChanged = function() {\n      $timeout(function(){\n        if(!this.selectedNote.visible) {\n          this.selectFirstNote(false);\n        }\n      }.bind(this), 100)\n    }\n  });\n;angular.module('app.frontend')\n  .directive(\"tagsSection\", function(){\n    return {\n      restrict: 'E',\n      scope: {\n        addNew: \"&\",\n        selectionMade: \"&\",\n        willSelect: \"&\",\n        save: \"&\",\n        tags: \"=\",\n        allTag: \"=\",\n        user: \"=\",\n        updateNoteTag: \"&\"\n      },\n      templateUrl: 'frontend/tags.html',\n      replace: true,\n      controller: 'TagsCtrl',\n      controllerAs: 'ctrl',\n      bindToController: true,\n\n      link:function(scope, elem, attrs, ctrl) {\n        scope.$watch('ctrl.tags', function(newTags){\n          if(newTags) {\n            ctrl.setTags(newTags);\n          }\n        });\n\n        scope.$watch('ctrl.allTag', function(allTag){\n          if(allTag) {\n            ctrl.setAllTag(allTag);\n          }\n        });\n      }\n    }\n  })\n  .controller('TagsCtrl', function () {\n\n    var initialLoad = true;\n\n    this.setAllTag = function(allTag) {\n      this.selectTag(this.allTag);\n    }\n\n    this.setTags = function(tags) {\n      if(initialLoad) {\n          initialLoad = false;\n          this.selectTag(this.allTag);\n      } else {\n        if(tags && tags.length > 0) {\n          this.selectTag(tags[0]);\n        }\n      }\n    }\n\n    this.selectTag = function(tag) {\n      this.willSelect()(tag);\n      this.selectedTag = tag;\n      this.selectionMade()(tag);\n    }\n\n    this.clickedAddNewTag = function() {\n      if(this.editingTag) {\n        return;\n      }\n\n      this.newTag = new Tag({});\n      this.selectedTag = this.newTag;\n      this.editingTag = this.newTag;\n      this.addNew()(this.newTag);\n    }\n\n    var originalTagName = \"\";\n    this.onTagTitleFocus = function(tag) {\n      originalTagName = tag.title;\n    }\n\n    this.tagTitleDidChange = function(tag) {\n      this.editingTag = tag;\n    }\n\n    this.saveTag = function($event, tag) {\n      this.editingTag = null;\n      if(tag.title.length == 0) {\n        tag.title = originalTagName;\n        originalTagName = \"\";\n        return;\n      }\n\n      $event.target.blur();\n      if(!tag.title || tag.title.length == 0) {\n          return;\n      }\n\n      this.save()(tag, function(savedTag){\n        // _.merge(tag, savedTag);\n        this.selectTag(tag);\n        this.newTag = null;\n      }.bind(this));\n    }\n\n    this.noteCount = function(tag) {\n      var validNotes = Note.filterDummyNotes(tag.notes);\n      return validNotes.length;\n    }\n\n    this.handleDrop = function(e, newTag, note) {\n      this.updateNoteTag()(note, newTag, this.selectedTag);\n    }.bind(this)\n\n\n  });\n;angular.module('app.frontend')\n.controller('UsernameModalCtrl', function ($scope, apiController, Restangular, user, callback, $timeout) {\n  $scope.formData = {};\n\n  $scope.saveUsername = function() {\n    apiController.setUsername(user, $scope.formData.username, function(response){\n      var username = response.username;\n      user.username = username;\n      callback(username);\n      $scope.closeThisDialog();\n    })\n  }\n});\n;class Item {\n\n  constructor(json_obj) {\n\n    this.updateFromJSON(json_obj);\n\n    if(!this.uuid) {\n      this.uuid = Neeto.crypto.generateUUID();\n    }\n  }\n\n  static sortItemsByDate(items) {\n    items.sort(function(a,b){\n      return new Date(b.created_at) - new Date(a.created_at);\n    });\n  }\n\n  get contentObject() {\n    // console.log(\"getting content object from content\", this.content);\n    if(!this.content) {\n      return {};\n    }\n\n    if(this.content !== null && typeof this.content === 'object') {\n      // this is the case when mapping localStorage content, in which case the content is already parsed\n      return this.content;\n    }\n\n    return JSON.parse(this.content);\n  }\n\n  updateFromJSON(json) {\n    _.merge(this, json);\n    if(this.created_at) {\n      this.created_at = new Date(this.created_at);\n      this.updated_at = new Date(this.updated_at);\n    } else {\n      this.created_at = new Date();\n      this.updated_at = new Date();\n    }\n\n    if(json.content) {\n      this.mapContentToLocalProperties(this.contentObject);\n    }\n  }\n\n  mapContentToLocalProperties(contentObj) {\n\n  }\n\n  createContentJSONFromProperties() {\n    return this.structureParams();\n  }\n\n  referenceParams() {\n    // must override\n  }\n\n  structureParams() {\n    return {references: this.referenceParams()}\n  }\n\n  addItemAsRelationship(item) {\n    // must override\n  }\n\n  removeItemAsRelationship(item) {\n    // must override\n  }\n\n  removeAllRelationships() {\n    // must override\n  }\n\n  mergeMetadataFromItem(item) {\n    _.merge(this, _.omit(item, [\"content\"]));\n  }\n\n  referencesAffectedBySharingChange() {\n    // should be overriden to determine which references should be decrypted/encrypted\n    return null;\n  }\n\n  isPublic() {\n    return this.presentation_name;\n  }\n\n  isEncrypted() {\n    return this.encryptionEnabled() && this.content.substring(0, 3) === '001' ? true : false;\n  }\n\n  encryptionEnabled() {\n    return this.enc_item_key;\n  }\n\n  presentationURL() {\n    return this.presentation_url;\n  }\n\n}\n;class Action {\n  constructor(json) {\n      _.merge(this, json);\n\n      var comps = this.type.split(\":\");\n      if(comps.length > 0) {\n        this.repeatable = true;\n        this.repeatType = comps[0]; // 'watch' or 'poll'\n        this.repeatVerb = comps[1]; // http verb\n        this.repeatFrequency = comps[2];\n      }\n  }\n}\n\nclass Extension extends Item {\n  constructor(json) {\n      super(json);\n      _.merge(this, json);\n\n      this.content_type = \"Extension\";\n  }\n\n  mapContentToLocalProperties(contentObject) {\n    super.mapContentToLocalProperties(contentObject)\n    this.name = contentObject.name;\n    this.url = contentObject.url;\n    this.actions = contentObject.actions.map(function(action){\n      return new Action(action);\n    })\n  }\n\n  updateFromExternalResponseItem(externalResponseItem) {\n    _.merge(this, externalResponseItem);\n    this.actions = externalResponseItem.actions.map(function(action){\n      return new Action(action);\n    })\n  }\n\n  referenceParams() {\n    return null;\n  }\n\n  structureParams() {\n    var params = {\n      name: this.name,\n      url: this.url,\n      actions: this.actions\n    };\n\n    _.merge(params, super.structureParams());\n    return params;\n  }\n\n}\n;class Note extends Item {\n\n  constructor(json_obj) {\n    super(json_obj);\n\n    if(!this.tags) {\n      this.tags = [];\n    }\n  }\n\n  mapContentToLocalProperties(contentObject) {\n    super.mapContentToLocalProperties(contentObject)\n    this.title = contentObject.title;\n    this.text = contentObject.text;\n  }\n\n  referenceParams() {\n    var references = _.map(this.tags, function(tag){\n      return {uuid: tag.uuid, content_type: tag.content_type};\n    })\n\n    return references;\n  }\n\n  structureParams() {\n    var params = {\n      title: this.title,\n      text: this.text\n    };\n\n    _.merge(params, super.structureParams());\n    return params;\n  }\n\n  addItemAsRelationship(item) {\n    if(item.content_type == \"Tag\") {\n      if(!_.find(this.tags, item)) {\n        this.tags.push(item);\n      }\n    }\n    super.addItemAsRelationship(item);\n  }\n\n  removeItemAsRelationship(item) {\n    if(item.content_type == \"Tag\") {\n      _.pull(this.tags, item);\n    }\n    super.removeItemAsRelationship(item);\n  }\n\n  removeAllRelationships() {\n    this.tags.forEach(function(tag){\n      _.pull(tag.notes, this);\n      tag.dirty = true;\n    }.bind(this))\n    this.tags = [];\n  }\n\n  static filterDummyNotes(notes) {\n    var filtered = notes.filter(function(note){return note.dummy == false || note.dummy == null});\n    return filtered;\n  }\n\n  referencesAffectedBySharingChange() {\n    return super.referencesAffectedBySharingChange();\n  }\n\n  get hasOnePublicTag() {\n    for (var tag of this.tags) {\n      if(tag.isPublic()) {\n        return true\n      }\n    }\n    return false;\n  }\n\n  safeText() {\n    return this.text || \"\";\n  }\n\n  safeTitle() {\n    return this.title || \"\";\n  }\n\n  toJSON() {\n    return {uuid: this.uuid}\n  }\n\n  isSharedIndividually() {\n    return this.presentation_name;\n  }\n\n  isPublic() {\n    return super.isPublic() || this.hasOnePublicTag;\n  }\n\n  get content_type() {\n    return \"Note\";\n  }\n}\n;class Tag extends Item {\n\n  constructor(json_obj) {\n    super(json_obj);\n\n    if(!this.notes) {\n      this.notes = [];\n    }\n  }\n\n  mapContentToLocalProperties(contentObject) {\n    super.mapContentToLocalProperties(contentObject)\n    this.title = contentObject.title;\n  }\n\n  referenceParams() {\n    var references = _.map(this.notes, function(note){\n      return {uuid: note.uuid, content_type: note.content_type};\n    })\n\n    return references;\n  }\n\n  structureParams() {\n    var params = {\n      title: this.title\n    };\n\n    _.merge(params, super.structureParams());\n    return params;\n  }\n\n  addItemAsRelationship(item) {\n    if(item.content_type == \"Note\") {\n      if(!_.find(this.notes, item)) {\n        this.notes.unshift(item);\n      }\n    }\n    super.addItemAsRelationship(item);\n  }\n\n  removeItemAsRelationship(item) {\n    if(item.content_type == \"Note\") {\n      _.pull(this.notes, item);\n    }\n    super.removeItemAsRelationship(item);\n  }\n\n  removeAllRelationships() {\n    this.notes.forEach(function(note){\n      _.pull(note.tags, this);\n      note.dirty = true;\n    }.bind(this))\n\n    this.notes = [];\n  }\n\n  get content_type() {\n    return \"Tag\";\n  }\n\n  referencesAffectedBySharingChange() {\n    return this.notes;\n  }\n}\n;class User {\n  constructor(json_obj) {\n    _.merge(this, json_obj);\n  }\n}\n;angular.module('app.frontend')\n  .provider('apiController', function () {\n\n    function domainName()  {\n      var domain_comps = location.hostname.split(\".\");\n      var domain = domain_comps[domain_comps.length - 2] + \".\" + domain_comps[domain_comps.length - 1];\n      return domain;\n    }\n\n    var url;\n\n    this.defaultServerURL = function() {\n      if(!url) {\n        url = localStorage.getItem(\"server\");\n        if(!url) {\n          url = \"https://n3.standardnotes.org\";\n        }\n      }\n      return url;\n    }\n\n\n    this.$get = function($rootScope, Restangular, modelManager, ngDialog) {\n        return new ApiController($rootScope, Restangular, modelManager, ngDialog);\n    }\n\n    function ApiController($rootScope, Restangular, modelManager, ngDialog) {\n\n      this.setUser = function(user) {\n        this.user = user;\n      }\n\n      /*\n      Config\n      */\n\n      this.getServer = function() {\n        if(!url) {\n          url = localStorage.getItem(\"server\");\n          if(!url) {\n            url = \"https://n3.standardnotes.org\";\n            this.setServer(url);\n          }\n        }\n        return url;\n      }\n\n      this.setServer = function(url, refresh) {\n        localStorage.setItem(\"server\", url);\n        if(refresh) {\n          window.location.reload();\n        }\n      }\n\n\n      /*\n      Auth\n      */\n\n      this.getAuthParamsForEmail = function(email, callback) {\n        var request = Restangular.one(\"auth\", \"params\");\n        request.get({email: email}).then(function(response){\n          callback(response.plain());\n        })\n        .catch(function(response){\n          console.log(\"Error getting current user\", response);\n          callback(response.data);\n        })\n      }\n\n      this.getCurrentUser = function(callback) {\n        if(!localStorage.getItem(\"jwt\")) {\n          callback(null);\n          return;\n        }\n        Restangular.one(\"users/current\").get().then(function(response){\n          var user = response.plain();\n          callback(user);\n        }.bind(this))\n        .catch(function(response){\n          console.log(\"Error getting current user\", response);\n          callback(response.data);\n        })\n      }\n\n      this.login = function(email, password, callback) {\n        this.getAuthParamsForEmail(email, function(authParams){\n          if(!authParams) {\n            callback(null);\n            return;\n          }\n          Neeto.crypto.computeEncryptionKeysForUser(_.merge({email: email, password: password}, authParams), function(keys){\n            this.setMk(keys.mk);\n            var request = Restangular.one(\"auth/sign_in\");\n            var params = {password: keys.pw, email: email};\n            _.merge(request, params);\n            request.post().then(function(response){\n              localStorage.setItem(\"jwt\", response.token);\n              callback(response);\n            })\n            .catch(function(response){\n              callback(response.data);\n            })\n          }.bind(this));\n        }.bind(this))\n      }\n\n      this.register = function(email, password, callback) {\n        Neeto.crypto.generateInitialEncryptionKeysForUser({password: password, email: email}, function(keys){\n          this.setMk(keys.mk);\n          keys.mk = null;\n          var request = Restangular.one(\"auth\");\n          var params = _.merge({password: keys.pw, email: email}, keys);\n          _.merge(request, params);\n          request.post().then(function(response){\n            localStorage.setItem(\"jwt\", response.token);\n            callback(response);\n          })\n          .catch(function(response){\n            callback(response.data);\n          })\n        }.bind(this));\n      }\n\n      this.changePassword = function(user, current_password, new_password) {\n          this.getAuthParamsForEmail(email, function(authParams){\n            if(!authParams) {\n              callback(null);\n              return;\n            }\n            Neeto.crypto.computeEncryptionKeysForUser(_.merge({password: current_password, email: user.email}, authParams), function(currentKeys) {\n              Neeto.crypto.computeEncryptionKeysForUser(_.merge({password: new_password, email: user.email}, authParams), function(newKeys){\n                var data = {};\n                data.current_password = currentKeys.pw;\n                data.password = newKeys.pw;\n                data.password_confirmation = newKeys.pw;\n\n                var user = this.user;\n\n                this._performPasswordChange(currentKeys, newKeys, function(response){\n                  if(response && !response.error) {\n                    // this.showNewPasswordForm = false;\n                    // reencrypt data with new mk\n                    this.reencryptAllItemsAndSave(user, newKeys.mk, currentKeys.mk, function(success){\n                      if(success) {\n                        this.setMk(newKeys.mk);\n                        alert(\"Your password has been changed and your data re-encrypted.\");\n                      } else {\n                        // rollback password\n                        this._performPasswordChange(newKeys, currentKeys, function(response){\n                          alert(\"There was an error changing your password. Your password has been rolled back.\");\n                          window.location.reload();\n                        })\n                      }\n                    }.bind(this));\n                  } else {\n                    // this.showNewPasswordForm = false;\n                    alert(\"There was an error changing your password. Please try again.\");\n                  }\n                }.bind(this))\n              }.bind(this));\n            }.bind(this));\n          }.bind(this));\n      }\n\n      this._performPasswordChange = function(email, current_keys, new_keys, callback) {\n        var request = Restangular.one(\"auth\");\n        var params = {password: new_keys.pw, password_confirmation: new_keys.pw, current_password: current_keys.pw, email: email};\n        _.merge(request, params);\n        request.patch().then(function(response){\n          callback(response);\n        })\n      }\n\n\n      /*\n      User\n      */\n\n      this.setUsername = function(user, username, callback) {\n        var request = Restangular.one(\"users\", user.uuid);\n        request.username = username;\n        request.patch().then(function(response){\n          callback(response.plain());\n        })\n      }\n\n      /*\n      Ensures that if encryption is disabled, all local items are uncrypted,\n      and that if it's enabled, that all local items are encrypted\n      */\n      this.verifyEncryptionStatusOfAllItems = function(user, callback) {\n        var allItems = user.filteredItems();\n        var itemsNeedingUpdate = [];\n        allItems.forEach(function(item){\n          if(!item.isPublic()) {\n            if(item.encryptionEnabled() && !item.isEncrypted()) {\n              itemsNeedingUpdate.push(item);\n            }\n          } else {\n            if(item.isEncrypted()) {\n              itemsNeedingUpdate.push(item);\n            }\n          }\n        }.bind(this))\n\n        if(itemsNeedingUpdate.length > 0) {\n          console.log(\"verifying encryption, items need updating\", itemsNeedingUpdate);\n          this.saveBatchItems(user, itemsNeedingUpdate, callback)\n        }\n      }\n\n\n\n      /*\n      Items\n      */\n\n      this.syncWithOptions = function(callback, options = {}) {\n        if(!this.user.uuid) {\n          this.writeItemsToLocalStorage(function(responseItems){\n            this.handleItemsResponse(responseItems);\n            modelManager.clearDirtyItems();\n            if(callback) {\n              callback();\n            }\n          }.bind(this))\n          return;\n        }\n\n        var dirtyItems = modelManager.getDirtyItems();\n        var request = Restangular.one(\"items/sync\");\n        request.items = _.map(dirtyItems, function(item){\n          return this.createRequestParamsForItem(item, options.additionalFields);\n        }.bind(this));\n\n        // console.log(\"syncing items\", request.items);\n\n        if(this.syncToken) {\n          request.sync_token = this.syncToken;\n        }\n\n        request.post().then(function(response) {\n          modelManager.clearDirtyItems();\n          this.syncToken = response.sync_token;\n          $rootScope.$broadcast(\"sync:updated_token\", this.syncToken);\n\n          this.handleItemsResponse(response.retrieved_items, null);\n          // merge only metadata for saved items\n          var omitFields = [\"content\", \"enc_item_key\", \"auth_hash\"];\n          this.handleItemsResponse(response.saved_items, omitFields);\n\n          if(callback) {\n            callback(response);\n          }\n        }.bind(this))\n        .catch(function(response){\n          console.log(\"Sync error: \", response);\n          callback(null);\n        })\n      }\n\n      this.sync = function(callback) {\n        this.syncWithOptions(callback, undefined);\n      }\n\n      this.handleItemsResponse = function(responseItems, omitFields) {\n        this.decryptItems(responseItems);\n        return modelManager.mapResponseItemsToLocalModelsOmittingFields(responseItems, omitFields);\n      }\n\n      this.createRequestParamsForItem = function(item, additionalFields) {\n        return this.paramsForItem(item, !item.isPublic(), additionalFields, false);\n      }\n\n      this.paramsForItem = function(item, encrypted, additionalFields, forExportFile) {\n        var itemCopy = _.cloneDeep(item);\n\n        console.assert(!item.dummy, \"Item is dummy, should not have gotten here.\", item.dummy)\n\n        var params = {uuid: item.uuid, content_type: item.content_type,\n          presentation_name: item.presentation_name, deleted: item.deleted};\n\n        if(encrypted) {\n          this.encryptSingleItem(itemCopy, this.retrieveMk());\n          params.content = itemCopy.content;\n          params.enc_item_key = itemCopy.enc_item_key;\n          params.auth_hash = itemCopy.auth_hash;\n        }\n        else {\n          params.content = forExportFile ? itemCopy.content : \"000\" + Neeto.crypto.base64(JSON.stringify(itemCopy.createContentJSONFromProperties()));\n          if(!forExportFile) {\n            params.enc_item_key = null;\n            params.auth_hash = null;\n          }\n        }\n\n        if(additionalFields) {\n          _.merge(params, _.pick(item, additionalFields));\n        }\n\n        return params;\n      }\n\n      this.shareItem = function(item, callback) {\n        if(!this.user.uuid) {\n          alert(\"You must be signed in to share.\");\n          return;\n        }\n\n        var shareFn = function() {\n          item.presentation_name = \"_auto_\";\n          var needsUpdate = [item].concat(item.referencesAffectedBySharingChange() || []);\n          needsUpdate.forEach(function(needingUpdate){\n            needingUpdate.dirty = true;\n          })\n          this.sync();\n        }.bind(this)\n\n        if(!this.user.username) {\n          ngDialog.open({\n            template: 'frontend/modals/username.html',\n            controller: 'UsernameModalCtrl',\n            resolve: {\n              user: function() {return this.user}.bind(this),\n              callback: function() {\n                return shareFn;\n              }\n            },\n            className: 'ngdialog-theme-default',\n            disableAnimation: true\n          });\n        } else {\n          shareFn();\n        }\n      }\n\n      this.unshareItem = function(item, callback) {\n        item.presentation_name = null;\n        var needsUpdate = [item].concat(item.referencesAffectedBySharingChange() || []);\n        needsUpdate.forEach(function(needingUpdate){\n          needingUpdate.dirty = true;\n        })\n        this.sync(null);\n      }\n\n      /*\n      Import\n      */\n\n      this.importJSONData = function(jsonString, callback) {\n        var data = JSON.parse(jsonString);\n        modelManager.mapResponseItemsToLocalModels(data.items);\n        modelManager.items.forEach(function(item){\n          item.dirty = true;\n        })\n        this.syncWithOptions(callback, {additionalFields: [\"created_at\", \"updated_at\"]});\n      }\n\n      /*\n      Export\n      */\n\n      this.itemsDataFile = function() {\n        var textFile = null;\n        var makeTextFile = function (text) {\n          var data = new Blob([text], {type: 'text/json'});\n\n          // If we are replacing a previously generated file we need to\n          // manually revoke the object URL to avoid memory leaks.\n          if (textFile !== null) {\n            window.URL.revokeObjectURL(textFile);\n          }\n\n          textFile = window.URL.createObjectURL(data);\n\n          // returns a URL you can use as a href\n          return textFile;\n        }.bind(this);\n\n        var items = _.map(modelManager.items, function(item){\n          return _.omit(this.paramsForItem(item, false, [\"created_at\", \"updated_at\"], true), [\"deleted\"]);\n        }.bind(this));\n\n        var data = {\n          items: items\n        }\n\n        return makeTextFile(JSON.stringify(data, null, 2 /* pretty print */));\n      }\n\n\n\n      /*\n      Merging\n      */\n      this.mergeLocalDataRemotely = function(user, callback) {\n        var request = Restangular.one(\"users\", user.uuid).one(\"merge\");\n        var tags = user.tags;\n        request.items = user.items;\n        request.items.forEach(function(item){\n          if(item.tag_id) {\n            var tag = tags.filter(function(tag){return tag.uuid == item.tag_id})[0];\n            item.tag_name = tag.title;\n          }\n        })\n        request.post().then(function(response){\n          callback();\n          localStorage.removeItem('user');\n        })\n      }\n\n\n\n\n\n\n      this.staticifyObject = function(object) {\n        return JSON.parse(JSON.stringify(object));\n      }\n\n      this.writeItemsToLocalStorage = function(callback) {\n        var items = _.map(modelManager.items, function(item){\n          return this.paramsForItem(item, false, [\"created_at\", \"updated_at\"], false)\n        }.bind(this));\n        console.log(\"writing items to local\", items);\n        this.writeToLocalStorage('items', items);\n        callback(items);\n      }\n\n      this.writeToLocalStorage = function(key, value) {\n        localStorage.setItem(key, angular.toJson(value));\n      }\n\n      this.loadLocalItemsAndUser = function() {\n        var user = {};\n        var items = JSON.parse(localStorage.getItem('items')) || [];\n        items = this.handleItemsResponse(items);\n        Item.sortItemsByDate(items);\n        user.items = items;\n        user.shouldMerge = true;\n        return user;\n      }\n\n      /*\n      Drafts\n      */\n\n      this.saveDraftToDisk = function(draft) {\n        localStorage.setItem(\"draft\", JSON.stringify(draft));\n      }\n\n      this.clearDraft = function() {\n        localStorage.removeItem(\"draft\");\n      }\n\n      this.getDraft = function() {\n        var draftString = localStorage.getItem(\"draft\");\n        if(!draftString || draftString == 'undefined') {\n          return null;\n        }\n        return new Note(JSON.parse(draftString));\n      }\n\n\n      /*\n      Encrpytion\n      */\n\n      this.retrieveMk = function() {\n        if(!this.mk) {\n          this.mk = localStorage.getItem(\"mk\");\n        }\n        return this.mk;\n      }\n\n      this.setMk = function(mk) {\n        localStorage.setItem('mk', mk);\n      }\n\n      this.signout = function() {\n        localStorage.removeItem(\"jwt\");\n        localStorage.removeItem(\"mk\");\n      }\n\n      this.encryptSingleItem = function(item, masterKey) {\n        var item_key = null;\n        if(item.enc_item_key) {\n          item_key = Neeto.crypto.decryptText(item.enc_item_key, masterKey);\n        } else {\n          item_key = Neeto.crypto.generateRandomEncryptionKey();\n          item.enc_item_key = Neeto.crypto.encryptText(item_key, masterKey);\n        }\n\n        var ek = Neeto.crypto.firstHalfOfKey(item_key);\n        var ak = Neeto.crypto.secondHalfOfKey(item_key);\n        var encryptedContent = \"001\" + Neeto.crypto.encryptText(JSON.stringify(item.createContentJSONFromProperties()), ek);\n        var authHash = Neeto.crypto.hmac256(encryptedContent, ak);\n\n        item.content = encryptedContent;\n        item.auth_hash = authHash;\n        item.local_encryption_scheme = \"1.0\";\n      }\n\n       this.decryptSingleItem = function(item, masterKey) {\n         var item_key = Neeto.crypto.decryptText(item.enc_item_key, masterKey);\n\n         var ek = Neeto.crypto.firstHalfOfKey(item_key);\n         var ak = Neeto.crypto.secondHalfOfKey(item_key);\n         var authHash = Neeto.crypto.hmac256(item.content, ak);\n         if(authHash !== item.auth_hash || !item.auth_hash) {\n           console.log(\"Authentication hash does not match.\")\n           return;\n         }\n\n         var content = Neeto.crypto.decryptText(item.content.substring(3, item.content.length), ek);\n         item.content = content;\n       }\n\n       this.decryptItems = function(items) {\n         var masterKey = this.retrieveMk();\n         for (var item of items) {\n           if(item.deleted == true) {\n             continue;\n           }\n\n           if(item.content.substring(0, 3) == \"001\" && item.enc_item_key) {\n             // is encrypted\n             this.decryptSingleItem(item, masterKey);\n           } else {\n             // is base64 encoded\n             item.content = Neeto.crypto.base64Decode(item.content.substring(3, item.content.length))\n           }\n         }\n       }\n\n       this.reencryptAllItemsAndSave = function(user, newMasterKey, oldMasterKey, callback) {\n         var items = user.filteredItems();\n         items.forEach(function(item){\n           if(item.content.substring(0, 3) == \"001\" && item.enc_item_key) {\n             // first decrypt item_key with old key\n             var item_key = Neeto.crypto.decryptText(item.enc_item_key, oldMasterKey);\n             // now encrypt item_key with new key\n             item.enc_item_key = Neeto.crypto.encryptText(item_key, newMasterKey);\n           }\n         });\n\n         this.saveBatchItems(user, items, function(success) {\n           callback(success);\n         }.bind(this));\n       }\n     }\n});\n;angular\n  .module('app.frontend')\n  .directive('mbAutofocus', ['$timeout', function($timeout) {\n    return {\n      restrict: 'A',\n      scope: {\n        shouldFocus: \"=\"\n      },\n      link : function($scope, $element) {\n        $timeout(function() {\n          if($scope.shouldFocus) {\n            $element[0].focus();\n          }\n        });\n      }\n    }\n  }]);\n;angular\n  .module('app.frontend')\n  .directive('draggable', function() {\n  return  {\n    scope: {\n      note: \"=\"\n    },\n    link: function(scope, element) {\n      // this gives us the native JS object\n      var el = element[0];\n\n      el.draggable = true;\n\n      el.addEventListener(\n        'dragstart',\n        function(e) {\n          e.dataTransfer.effectAllowed = 'move';\n          e.dataTransfer.setData('Note', JSON.stringify(scope.note));\n          this.classList.add('drag');\n          return false;\n        },\n        false\n      );\n\n      el.addEventListener(\n        'dragend',\n        function(e) {\n          this.classList.remove('drag');\n          return false;\n        },\n        false\n      );\n    }\n  }\n});\n\nangular\n  .module('app.frontend')\n  .directive('droppable', function() {\n  return {\n    scope: {\n      drop: '&',\n      bin: '=',\n      tag: \"=\"\n    },\n    link: function(scope, element) {\n      // again we need the native object\n      var el = element[0];\n\n      el.addEventListener(\n        'dragover',\n        function(e) {\n          e.dataTransfer.dropEffect = 'move';\n          // allows us to drop\n          if (e.preventDefault) e.preventDefault();\n          this.classList.add('over');\n          return false;\n        },\n        false\n      );\n\n      var counter = 0;\n\n      el.addEventListener(\n        'dragenter',\n        function(e) {\n          counter++;\n          this.classList.add('over');\n          return false;\n        },\n        false\n      );\n\n      el.addEventListener(\n        'dragleave',\n        function(e) {\n          counter--;\n           if (counter === 0) {\n             this.classList.remove('over');\n           }\n          return false;\n        },\n        false\n      );\n\n      el.addEventListener(\n        'drop',\n        function(e) {\n          // Stops some browsers from redirecting.\n          if (e.stopPropagation) e.stopPropagation();\n\n          this.classList.remove('over');\n\n          var binId = this.uuid;\n          var note = new Note(JSON.parse(e.dataTransfer.getData('Note')));\n          scope.$apply(function(scope) {\n            var fn = scope.drop();\n            if ('undefined' !== typeof fn) {\n              fn(e, scope.tag, note);\n            }\n          });\n\n          return false;\n        },\n        false\n      );\n    }\n  }\n});\n;angular\n  .module('app.frontend')\n  .directive('fileChange', function() {\n    return {\n     restrict: 'A',\n     scope: {\n       handler: '&'\n     },\n     link: function (scope, element) {\n      element.on('change', function (event) {\n        scope.$apply(function(){\n          scope.handler({files: event.target.files});\n        });\n      });\n     }\n    };\n});\n;angular\n  .module('app.frontend')\n  .directive('lowercase', function() {\n    return {\n      require: 'ngModel',\n      link: function(scope, element, attrs, modelCtrl) {\n        var lowercase = function(inputValue) {\n          if (inputValue == undefined) inputValue = '';\n          var lowercased = inputValue.toLowerCase();\n          if (lowercased !== inputValue) {\n            modelCtrl.$setViewValue(lowercased);\n            modelCtrl.$render();\n          }\n          return lowercased;\n        }\n        modelCtrl.$parsers.push(lowercase);\n        lowercase(scope[attrs.ngModel]);\n      }\n    };\n  });\n;angular\n  .module('app.frontend')\n  .directive('selectOnClick', ['$window', function ($window) {\n    return {\n        restrict: 'A',\n        link: function (scope, element, attrs) {\n            element.on('focus', function () {\n                if (!$window.getSelection().toString()) {\n                    // Required for mobile Safari\n                    this.setSelectionRange(0, this.value.length)\n                }\n            });\n        }\n    };\n}]);\n;angular\n  .module('app.frontend')\n  .directive('note', function($timeout) {\n    return {\n      restrict: 'E',\n      controller: 'SingleNoteCtrl',\n      templateUrl: \"frontend/directives/note.html\",\n      scope: {\n        note: \"=\"\n      },\n    }\n  })\n  .controller('SingleNoteCtrl', function ($rootScope, $scope, $state, markdownRenderer) {\n    $scope.renderedContent = function() {\n      return markdownRenderer.renderHtml(markdownRenderer.renderedContentForText($scope.note.text));\n    }\n  });\n;/**\n * AngularJS directive that simulates the effect of typing on a text editor - with a blinking cursor.\n * This directive works as an attribute to any HTML element, and it changes the speed/delay of its animation.\n *\n * There's also a simple less file included for basic styling of the dialog, which can be overridden.\n * The config object also lets the user define custom CSS classes for the modal.\n *\n *  How to use:\n *\n *  Just add the desired text to the 'text' attribute of the element and the directive takes care of the rest.\n *  The 'text' attribute can be a single string or an array of string. In case an array is passed, the string\n *  on each index is erased so the next item can be printed. When the last index is reached, that string stays\n *  on the screen. (So if you want to erase the last string, just push an empty string to the end of the array)\n *\n * These are the optional preferences:\n *  - initial delay: set an 'initial-delay' attribute for the element\n *  - type delay: set a 'type-delay' attribute for the element\n *  - erase delay: set a 'erase-delay' attribute for the element\n *  - specify cursor : set a 'cursor' attribute for the element, specifying which cursor to use\n *  - turn off cursor blinking: set the 'blink-cursor' attribute  to \"false\"\n *  - cursor blinking speed: set a 'blink-delay' attribute for the element\n *  - scope callback: pass the desired scope callback as the 'callback-fn' attribute of the element\n *\n * Note:\n * Each time/delay value should be set either on seconds (1s) or milliseconds (1000)\n *\n * Dependencies:\n * The directive needs the css file provided in order to replicate the cursor blinking effect.\n */\n\n\nangular\n    .module('app.frontend').directive('typewrite', ['$timeout', function ($timeout) {\n        function linkFunction($scope, $element, $attrs) {\n            var timer = null,\n                initialDelay = $attrs.initialDelay ? getTypeDelay($attrs.initialDelay) : 200,\n                typeDelay = $attrs.typeDelay || 200,\n                eraseDelay = $attrs.eraseDelay || typeDelay / 2,\n                blinkDelay = $attrs.blinkDelay ? getAnimationDelay($attrs.blinkDelay) : false,\n                cursor = $attrs.cursor || '|',\n                blinkCursor = typeof $attrs.blinkCursor !== 'undefined' ? $attrs.blinkCursor === 'true' : true,\n                currentText,\n                textArray,\n                running,\n                auxStyle;\n\n\n\n            if ($scope.text) {\n                if ($scope.text instanceof Array) {\n                    textArray = $scope.text;\n                    currentText = textArray[0];\n                } else {\n                    currentText = $scope.text;\n                }\n            }\n            if (typeof $scope.start === 'undefined' || $scope.start) {\n                typewrite();\n            }\n\n            function typewrite() {\n                timer = $timeout(function () {\n                    updateIt($element, 0, 0, currentText);\n                }, initialDelay);\n            }\n\n            function updateIt(element, charIndex, arrIndex, text) {\n                if (charIndex <= text.length) {\n                    updateValue(element, text.substring(0, charIndex) + cursor);\n                    charIndex++;\n                    timer = $timeout(function () {\n                        updateIt(element, charIndex, arrIndex, text);\n                    }, typeDelay);\n                    return;\n                } else {\n                    charIndex--;\n\n                    if($scope.iterationCallback) {\n                      $scope.iterationCallback()(arrIndex);\n                    }\n\n                    // check if it's an array\n                    if (textArray && arrIndex < textArray.length - 1) {\n                        timer = $timeout(function () {\n                            cleanAndRestart(element, charIndex, arrIndex, textArray[arrIndex]);\n                        }, $scope.iterationDelay);\n                    } else {\n                        if ($scope.callbackFn) {\n                            $scope.callbackFn();\n                        }\n                        blinkIt(element, charIndex, currentText);\n                    }\n                }\n            }\n\n            function blinkIt(element, charIndex) {\n                var text = element.text().substring(0, element.text().length - 1);\n                if (blinkCursor) {\n                    if (blinkDelay) {\n                        auxStyle = '-webkit-animation:blink-it steps(1) ' + blinkDelay + ' infinite;-moz-animation:blink-it steps(1) ' + blinkDelay + ' infinite ' +\n                            '-ms-animation:blink-it steps(1) ' + blinkDelay + ' infinite;-o-animation:blink-it steps(1) ' + blinkDelay + ' infinite; ' +\n                            'animation:blink-it steps(1) ' + blinkDelay + ' infinite;';\n                        updateValue(element, text.substring(0, charIndex) + '<span class=\"blink\" style=\"' + auxStyle + '\">' + cursor + '</span>');\n                    } else {\n                        updateValue(element, text.substring(0, charIndex) + '<span class=\"blink\">' + cursor + '</span>');\n                    }\n                } else {\n                    updateValue(element, text.substring(0, charIndex));\n                }\n            }\n\n            function cleanAndRestart(element, charIndex, arrIndex, currentText) {\n              if(charIndex == 0) {\n                if($scope.prebeginFn) {\n                  $scope.prebeginFn()();\n                }\n              }\n                if (charIndex > 0) {\n                    currentText = currentText.slice(0, -1);\n                    // element.html(currentText.substring(0, currentText.length - 1) + cursor);\n                    updateValue(element, currentText + cursor);\n                    charIndex--;\n                    timer = $timeout(function () {\n                        cleanAndRestart(element, charIndex, arrIndex, currentText);\n                    }, eraseDelay);\n                    return;\n                } else {\n                    arrIndex++;\n                    currentText = textArray[arrIndex];\n                    timer = $timeout(function () {\n                        updateIt(element, 0, arrIndex, currentText);\n                    }, typeDelay);\n                }\n            }\n\n            function getTypeDelay(delay) {\n                if (typeof delay === 'string') {\n                    return delay.charAt(delay.length - 1) === 's' ? parseInt(delay.substring(0, delay.length - 1), 10) * 1000 : +delay;\n                } else {\n                    return false;\n                }\n            }\n\n            function getAnimationDelay(delay) {\n                if (typeof delay === 'string') {\n                    return delay.charAt(delay.length - 1) === 's' ? delay : parseInt(delay.substring(0, delay.length - 1), 10) / 1000;\n                }\n            }\n\n            function updateValue(element, value) {\n                if (element.prop('nodeName').toUpperCase() === 'INPUT') {\n                    return element.val(value);\n                }\n                return element.html(value);\n            }\n\n            $scope.$on('$destroy', function () {\n                if (timer) {\n                    $timeout.cancel(timer);\n                }\n            });\n\n            $scope.$watch('start', function (newVal) {\n                if (!running && newVal) {\n                    running = !running;\n                    typewrite();\n                }\n            });\n\n            $scope.$watch('text', function (newVal, oldVal) {\n              if(!(newVal instanceof Array)) {\n                currentText = newVal;\n                typewrite();\n              }\n            });\n        }\n\n        return {\n            restrict: 'A',\n            link: linkFunction,\n            replace: true,\n            scope: {\n                text: '=',\n                callbackFn: '&',\n                iterationCallback: '&',\n                iterationDelay: '=',\n                prebeginFn: '&',\n                start: '='\n            }\n        };\n\n    }]);\n;class ExtensionManager {\n\n  constructor(Restangular, modelManager, apiController) {\n      this.Restangular = Restangular;\n      this.modelManager = modelManager;\n      this.apiController = apiController;\n      this.enabledRepeatActionUrls = JSON.parse(localStorage.getItem(\"enabledRepeatActionUrls\")) || [];\n\n      modelManager.addItemSyncObserver(\"extensionManager\", \"Extension\", function(items){\n        for (var ext of items) {\n          for (var action of ext.actions) {\n            if(this.enabledRepeatActionUrls.includes(action.url)) {\n              this.enableRepeatAction(action, ext);\n            }\n          }\n        }\n      }.bind(this))\n  }\n\n  get extensions() {\n    return this.modelManager.extensions;\n  }\n\n  actionWithURL(url) {\n    for (var extension of this.extensions) {\n      return _.find(extension.actions, {url: url})\n    }\n  }\n\n  addExtension(url) {\n    this.retrieveExtensionFromServer(url, null);\n  }\n\n  retrieveExtensionFromServer(url, callback) {\n    console.log(\"Registering URL\", url);\n    this.Restangular.oneUrl(url, url).get().then(function(response){\n      console.log(\"get response\", response.plain());\n      var ext = this.handleExtensionLoadExternalResponseItem(url, response.plain());\n      if(callback) {\n        callback(ext);\n      }\n    }.bind(this))\n    .catch(function(response){\n      console.log(\"Error registering extension\", response);\n    })\n  }\n\n  handleExtensionLoadExternalResponseItem(url, externalResponseItem) {\n    var extension = _.find(this.extensions, {url: url});\n    if(extension) {\n      extension.updateFromExternalResponseItem(externalResponseItem);\n      console.log(\"updated existing ext\", extension);\n    } else {\n      console.log(\"creating new ext\", externalResponseItem);\n      extension = new Extension(externalResponseItem);\n      extension.url = url;\n      extension.dirty = true;\n      this.modelManager.addItem(extension);\n      this.apiController.sync(null);\n    }\n\n    return extension;\n  }\n\n  refreshExtensionsFromServer() {\n    for (var url of this.enabledRepeatActionUrls) {\n      var action = this.actionWithURL(url);\n      this.disableRepeatAction(action);\n    }\n\n    for(var ext of this.extensions) {\n      this.retrieveExtensionFromServer(ext.url, function(extension){\n        extension.dirty = true;\n      });\n    }\n  }\n\n  executeAction(action, extension, callback) {\n    if(action.type == \"get\") {\n      this.Restangular.oneUrl(action.url, action.url).get().then(function(response){\n        console.log(\"Execute action response\", response);\n        var items = response.items;\n        this.modelManager.mapResponseItemsToLocalModels(items);\n        callback(items);\n      }.bind(this))\n    }\n  }\n\n  isRepeatActionEnabled(action) {\n    return this.enabledRepeatActionUrls.includes(action.url);\n  }\n\n  disableRepeatAction(action, extension) {\n    console.log(\"Disabling action\", action);\n    _.pull(this.enabledRepeatActionUrls, action.url);\n    this.modelManager.removeItemSyncObserver(action.url);\n    console.assert(this.isRepeatActionEnabled(action) == false);\n  }\n\n  enableRepeatAction(action, extension) {\n    console.log(\"Enabling repeat action\", action);\n\n    if(!_.find(this.enabledRepeatActionUrls, action.url)) {\n      this.enabledRepeatActionUrls.push(action.url);\n      localStorage.setItem(\"enabledRepeatActionUrls\", JSON.stringify(this.enabledRepeatActionUrls));\n    }\n\n    if(action.repeatType == \"watch\") {\n      for(var structure of action.structures) {\n        this.modelManager.addItemSyncObserver(action.url, structure.type, function(changedItems){\n          this.triggerWatchAction(action, changedItems);\n        }.bind(this))\n      }\n    }\n  }\n\n  queueAction(action, delay, changedItems) {\n    this.actionQueue = this.actionQueue || [];\n    if(_.find(this.actionQueue, action)) {\n      // console.log(\"Action already queued, skipping.\")\n      return;\n    }\n\n    // console.log(\"Adding action to queue\", action);\n\n    this.actionQueue.push(action);\n\n    setTimeout(function () {\n      console.log(\"Performing queued action\", action);\n      this.triggerWatchAction(action, changedItems);\n      _.pull(this.actionQueue, action);\n    }.bind(this), delay * 1000);\n  }\n\n  triggerWatchAction(action, changedItems) {\n    // console.log(\"Watch action triggered\", action, changedItems);\n    if(action.repeatFrequency > 0) {\n      var lastExecuted = action.lastExecuted;\n      var diffInSeconds = (new Date() - lastExecuted)/1000;\n      console.log(\"last executed\", action.lastExecuted, \"diff\", diffInSeconds, \"repeatFreq\", action.repeatFrequency);\n      if(diffInSeconds < action.repeatFrequency) {\n        var delay = action.repeatFrequency - diffInSeconds;\n        console.log(\"delaying action by\", delay);\n        this.queueAction(action, delay, changedItems);\n        return;\n      }\n    }\n\n    console.log(\"Performing action immediately\", action);\n    action.lastExecuted = new Date();\n    // console.log(\"setting last exectured\", action.lastExecuted)\n\n    if(action.repeatVerb == \"post\") {\n      var request = this.Restangular.oneUrl(action.url, action.url);\n      request.items = changedItems.map(function(item){\n        var params = {uuid: item.uuid, content_type: item.content_type, content: item.createContentJSONFromProperties()};\n        return params;\n      })\n      request.post().then(function(response){\n        // console.log(\"watch action response\", response);\n      })\n    }\n  }\n\n}\n\nangular.module('app.frontend').service('extensionManager', ExtensionManager);\n;angular.module('app.frontend')\n  .filter('appDate', function ($filter) {\n      return function (input) {\n          return input ? $filter('date')(new Date(input), 'MM/dd/yyyy', 'UTC') : '';\n      };\n  })\n  .filter('appDateTime', function ($filter) {\n      return function (input) {\n          return input ? $filter('date')(new Date(input), 'MM/dd/yyyy h:mm a') : '';\n      };\n  });\n;angular.module('app.frontend')\n  .service('markdownRenderer', function ($sce) {\n\n    marked.setOptions({\n      breaks: true,\n      sanitize: true\n    });\n\n    this.renderedContentForText = function(text) {\n      if(!text || text.length == 0) {\n        return \"\";\n      }\n      return marked(text);\n    }\n\n    this.renderHtml = function(html_code) {\n      return $sce.trustAsHtml(html_code);\n    };\n\n\n  });\n;class ModelManager {\n\n  constructor() {\n    this.notes = [];\n    this.tags = [];\n    this.itemSyncObservers = [];\n    this.items = [];\n    this.extensions = [];\n  }\n\n  findItem(itemId) {\n    return _.find(this.items, {uuid: itemId});\n  }\n\n  mapResponseItemsToLocalModels(items) {\n    return this.mapResponseItemsToLocalModelsOmittingFields(items, null);\n  }\n\n  mapResponseItemsToLocalModelsOmittingFields(items, omitFields) {\n    var models = []\n    for (var json_obj of items) {\n      json_obj = _.omit(json_obj, omitFields || [])\n      var item = this.findItem(json_obj[\"uuid\"]);\n      if(json_obj[\"deleted\"] == true) {\n          if(item) {\n            this.removeItemLocally(item)\n          }\n          continue;\n      }\n\n      _.omit(json_obj, omitFields);\n\n      if(!item) {\n        item = this.createItem(json_obj);\n      } else {\n        item.updateFromJSON(json_obj);\n      }\n\n      this.addItem(item);\n\n      if(json_obj.content) {\n        this.resolveReferencesForItem(item)\n      }\n\n      models.push(item)\n    }\n\n    for(var observer of this.itemSyncObservers) {\n      var relevantItems = models.filter(function(item){return item.content_type == observer.type});\n      if(relevantItems.length > 0) {\n        observer.callback(relevantItems);\n      }\n    }\n\n    this.sortItems();\n    return models;\n  }\n\n  createItem(json_obj) {\n    if(json_obj.content_type == \"Note\") {\n      return new Note(json_obj);\n    } else if(json_obj.content_type == \"Tag\") {\n      return new Tag(json_obj);\n    } else if(json_obj.content_type == \"Extension\") {\n      return new Extension(json_obj);\n    } else {\n      return new Item(json_obj);\n    }\n  }\n\n  addItems(items) {\n    this.items = _.uniq(this.items.concat(items));\n\n    items.forEach(function(item){\n      if(item.content_type == \"Tag\") {\n        if(!_.find(this.tags, {uuid: item.uuid})) {\n          this.tags.unshift(item);\n        }\n      } else if(item.content_type == \"Note\") {\n        if(!_.find(this.notes, {uuid: item.uuid})) {\n          this.notes.unshift(item);\n        }\n      } else if(item.content_type == \"Extension\") {\n        if(!_.find(this.extensions, {uuid: item.uuid})) {\n          this.extensions.unshift(item);\n        }\n      }\n    }.bind(this))\n  }\n\n  addItem(item) {\n    this.addItems([item])\n  }\n\n  itemsForContentType(contentType) {\n    return this.items.filter(function(item){\n      return item.content_type == contentType;\n    });\n  }\n\n  resolveReferencesForItem(item) {\n    var contentObject = item.contentObject;\n    if(!contentObject.references) {\n      return;\n    }\n\n    for(var reference of contentObject.references) {\n      var referencedItem = this.findItem(reference.uuid);\n      if(referencedItem) {\n        item.addItemAsRelationship(referencedItem);\n        referencedItem.addItemAsRelationship(item);\n      } else {\n        console.log(\"Unable to find item:\", reference.uuid);\n      }\n    }\n  }\n\n  sortItems() {\n    Item.sortItemsByDate(this.notes);\n\n    this.tags.forEach(function(tag){\n      Item.sortItemsByDate(tag.notes);\n    })\n  }\n\n  addItemSyncObserver(id, type, callback) {\n    this.itemSyncObservers.push({id: id, type: type, callback: callback});\n  }\n\n  removeItemSyncObserver(id) {\n    _.remove(this.itemSyncObservers, _.find(this.itemSyncObservers, {id: id}));\n  }\n\n  get filteredNotes() {\n    return Note.filterDummyNotes(this.notes);\n  }\n\n  getDirtyItems() {\n    return this.items.filter(function(item){return item.dirty == true && !item.dummy})\n  }\n\n  clearDirtyItems() {\n    this.getDirtyItems().forEach(function(item){\n      item.dirty = false;\n    })\n  }\n\n  setItemToBeDeleted(item) {\n    item.deleted = true;\n    item.dirty = true;\n    item.removeAllRelationships();\n  }\n\n  removeItemLocally(item) {\n    _.pull(this.items, item);\n\n    if(item.content_type == \"Tag\") {\n      _.pull(this.tags, item);\n    } else if(item.content_type == \"Note\") {\n      _.pull(this.notes, item);\n    } else if(item.content_type == \"Extension\") {\n      _.pull(this.extensions, item);\n    }\n  }\n\n  /*\n  Relationships\n  */\n\n  createRelationshipBetweenItems(itemOne, itemTwo) {\n    itemOne.addItemAsRelationship(itemTwo);\n    itemTwo.addItemAsRelationship(itemOne);\n\n    itemOne.dirty = true;\n    itemTwo.dirty = true;\n  }\n\n  removeRelationshipBetweenItems(itemOne, itemTwo) {\n    itemOne.removeItemAsRelationship(itemTwo);\n    itemTwo.removeItemAsRelationship(itemOne);\n\n    itemOne.dirty = true;\n    itemTwo.dirty = true;\n  }\n}\n\nangular.module('app.frontend').service('modelManager', ModelManager);\n;angular.module('app.frontend')\n  .service('serverSideValidation', function ($sce) {\n    // Show validation errors in form.\n    this.showErrors = function (formErrors, form) {\n      angular.forEach(formErrors, function (errors, key) {\n        if (typeof form[key] !== 'undefined') {\n          form[key].$setDirty();\n          form[key].$setValidity('server', false);\n          form[key].$error.server = $sce.trustAsHtml(errors.join(', '));\n        }\n      });\n    };\n\n    // Get validation errors from server response and show them in form.\n    this.parseErrors = function (response, form) {\n      if (response.status === 422) {\n        this.showErrors(response.data, form);\n      }\n    };\n});\n"]}